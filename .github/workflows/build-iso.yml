name: Build Bootable ISO

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'boot/**'
      - 'src/slopos.c'
      - 'Makefile*'
      - '.github/workflows/build-iso.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-iso:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          gcc-multilib \
          g++-multilib \
          nasm \
          grub-pc-bin \
          grub-common \
          xorriso \
          mtools \
          qemu-system-x86
    
    - name: Check for kernel files
      id: check_kernel
      run: |
        if [ -d "boot" ] && [ -f "Makefile.simple" ] && [ -f "src/slopos.c" ] && [ -f "boot/boot.s" ]; then
          echo "kernel_exists=true" >> $GITHUB_OUTPUT
          echo "Kernel source found - will build ISO"
        else
          echo "kernel_exists=false" >> $GITHUB_OUTPUT
          echo "No kernel source found - skipping ISO build"
          echo "Note: This is normal if you only have the simulator"
        fi
    
    - name: Build kernel
      if: steps.check_kernel.outputs.kernel_exists == 'true'
      run: |
        if [ -f "Makefile.simple" ]; then
          make -f Makefile.simple
        elif [ -f "Makefile" ]; then
          make
        fi
    
    - name: Build ISO
      if: steps.check_kernel.outputs.kernel_exists == 'true'
      run: |
        if [ -f "Makefile.simple" ]; then
          make -f Makefile.simple iso || make iso
        elif [ -f "Makefile" ]; then
          make iso
        fi
    
    - name: Verify ISO
      if: steps.check_kernel.outputs.kernel_exists == 'true'
      run: |
        if [ -f "slopos.iso" ]; then
          ls -lh slopos.iso
          echo "ISO size: $(du -h slopos.iso | cut -f1)"
        else
          echo "ISO file not found!"
          exit 1
        fi
    
    - name: Test ISO in QEMU (headless)
      if: steps.check_kernel.outputs.kernel_exists == 'true'
      run: |
        timeout 10s qemu-system-i386 \
          -cdrom slopos.iso \
          -m 32M \
          -nographic \
          -serial mon:stdio \
          || true
        echo "QEMU boot test completed"
    
    - name: Get version info
      if: steps.check_kernel.outputs.kernel_exists == 'true'
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="iso-$(date +'%Y%m%d-%H%M%S')-${GITHUB_SHA::8}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Upload ISO artifact
      if: steps.check_kernel.outputs.kernel_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: slopos-iso-${{ steps.version.outputs.version }}
        path: |
          slopos.iso
          slopos.bin
        retention-days: 90
    
    - name: Create release with ISO
      if: steps.check_kernel.outputs.kernel_exists == 'true' && startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          slopos.iso
          slopos.bin
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## üíø slopOS Bootable ISO Release ${{ steps.version.outputs.version }}
          
          ### üì• Quick Download
          **[‚¨áÔ∏è Download slopos.iso](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/slopos.iso)** - Ready to boot!
          
          ### üì¶ What's Included
          - **slopos.iso** (5MB) - Bootable ISO image for VirtualBox, VMware, QEMU, or real hardware
          - **slopos.bin** (24KB) - Raw kernel binary (for QEMU direct kernel boot)
          
          ### üöÄ Quick Start
          
          #### Option 1: QEMU (Fastest)
          ```bash
          wget ${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/slopos.iso
          qemu-system-i386 -cdrom slopos.iso -m 32M
          ```
          
          #### Option 2: VirtualBox
          1. Download `slopos.iso` from the assets above
          2. Create a new VM:
             - Type: **Other**
             - Version: **Other/Unknown**
             - Memory: **32MB** minimum (128MB recommended)
          3. Settings ‚Üí Storage ‚Üí Add optical drive ‚Üí Select `slopos.iso`
          4. Start the VM
          
          #### Option 3: VMware
          1. Download `slopos.iso`
          2. Create a new VM (Guest OS: Other)
          3. Set memory to 32MB minimum
          4. Mount `slopos.iso` as CD/DVD
          5. Power on
          
          #### Option 4: Real Hardware (USB Boot)
          ```bash
          sudo dd if=slopos.iso of=/dev/sdX bs=4M status=progress
          sync
          ```
          ‚ö†Ô∏è Replace `/dev/sdX` with your USB drive (check with `lsblk`)
          
          ### üîê Default Credentials
          - **Admin User**
            - Username: `admin`
            - Password: `slopOS123`
            - Has administrator privileges
          
          - **Regular User**
            - Username: `user`
            - Password: `password`
            - Standard user privileges
          
          ### üéØ Features
          - ‚úÖ Multi-user authentication with SHA256 password hashing
          - ‚úÖ Hierarchical filesystem (mkdir, touch, ls, cd, pwd)
          - ‚úÖ PS/2 keyboard driver with shift key support
          - ‚úÖ VGA text mode with color output
          - ‚úÖ User management (whoami, listusers)
          - ‚úÖ Admin/regular user roles with permissions
          
          ### üíª Available Commands
          ```
          help       - Show all commands
          ls         - List directory contents
          mkdir      - Create directory
          touch      - Create file
          cd         - Change directory (use 'cd ..' for parent)
          pwd        - Print working directory
          whoami     - Show current user and role
          listusers  - List all users (admin only)
          clear      - Clear screen
          ```
          
          ### ‚öôÔ∏è System Requirements
          - **Processor**: x86 compatible (32-bit)
          - **Memory**: 32MB minimum
          - **Display**: VGA-compatible
          - **Keyboard**: PS/2 or USB (BIOS compatibility mode)
          
          ### üìù Notes
          - Changes are not persistent (in-memory filesystem only)
          - Maximum 256 filesystem entries
          - Shift key works for capital letters and symbols
          - 3 login attempts before system halt
          - x86 compatible processor
          - 32MB RAM minimum
          - VGA-compatible display
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
